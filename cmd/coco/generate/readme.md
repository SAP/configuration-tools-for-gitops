# File generation

The packages in this folder are used to generate boilerplate configuration files
for all environments.

Files in this category are e.g.:

- SealedSecret Templates for the secret-management cli
- files in overlay folders
- value files under `.../values/cluster-values`
- files under `values-cluster`

## Why is this needed?

The file generation shall solve the following issues

- missing environment-specific configurations when adding or changing a service
- easing the creation of new environments by auto-generating what is possible
  and marking what is missing for easy refactoring
- preventing configuration drift for environment-specific configurations in
  service values

### How can the needs be adressed?

With this tool we can run an automated file-generation on every pull-request
which allows for the following features:

- `diff` detection: find missing configurations for all service-environment
  combinations
- drift prevention: all environment-specific configurations are recreated by the
  tool, which prevents accidental configuration drift between environments

For new environments, running the file-generation gives a comprehensive and
minimal list of needed manual inputs.

## How it works

In general, the file generation CLI depends on a set of global inputs (the
`values-cluster` files). These input files govern which files will be generated
and what values are generated automatically.

### Naming rules

The structure of generated files is defined by a local template file (identified
by its ending `.tmpl`) that appears on the same level as the files that will be
generated.

If the template file has no name and just the ending (i.e. `.tmpl`), the
generated file will take the full cluster-name, and otherwise the template name
is prefixed as e.g.:

```file
.tmpl      ->  aws.eu-west-1.gitops-pr1.yaml
name.tmpl  ->  name--aws.eu-west-1.gitops-pr1.yaml
```

Similarely whole subfolders can be template folders and similar naming rules as
above apply:

```folder
.tmpl/      ->  aws.eu-west-1.gitops-pr1/
name.tmpl/  ->  name--aws.eu-west-1.gitops-pr1/
```

In a `.tmpl` folder all files will be treated as template files and they will be
rendered and copied to the generated subfolders. In contrast to template files
outside of `.tmpl` folders these files will not undergo the renaming procedure.
This means that their names persist in every generated environment folder.

### Exceptions

#### Version differences

Per default, file generation will only take control over generated files that
hold the same version as the file generation tool itself, e.g. a file with the
first line
`# Code generated by CLI 'coco generate ...' (version: v99.99.99); DO NOT EDIT.`
will only be changed by `coco` in version `v99.99.99`.

#### Manual overwrites

Normally generated files cannot be manipulated by hand since their content will
be overwritten once the file-generation CLI is run again.

If there is a need to create an exception for this overwrite mechanism, the
following key indications or 1-line indications can be used to prevent the
delition of the marked lines.

```yaml
persistent: line # HumanInput
alsoPersistent: !HumanInput line
line: that will be overwritten
```

### Example (helm value files)

#### Setup

This example deals with environment-specific values for rendering a helm-chart
like they can be found e.g.
[here](https://github.tools.sap/MLF/mlf-gitops/tree/main/services/external-dns/values/cluster-values/ingress).
The relevant inputs for file-generation CLI are in the following files

```file
+-- services
|   +-- external-dns
|   |   +-- values
|   |   |   +-- cluster-values
|   |   |   |   +-- .tmpl
|   |   |   |   +-- aws.eu-central-1.prod-eu.yaml
...
+-- values-cluster
|   +-- aws.eu-central-1.prod-eu.yaml
|   +-- gcp.us-central1.integration.yaml
|   +-- aws.eu-west-1.gitops-pr1.yaml
```

Here the `.tmpl` file contains a golang template. This template will be rendered
by the CLI with the values for each environment specified in
`values-cluster/${cloud}.${region}.${name}.yaml`. The resulting file will be
stored under
`services/external-dns/cluster-values/${cloud}.${region}.${name}.yaml`.

Note that there exists already one file
`services/external-dns/cluster-values/cloud_1.region_1.name_1.yaml`. The content
of this file will be overwritten unless exceptions have been specified - see
[Exceptions](#Exceptions). The existing file `aws.eu-central-1.prod-eu.yaml` has
the form:

```yaml
# Code generated by CLI 'coco generate ...' (version: v99.99.99); DO NOT EDIT.

MyFavorite: Value # HumanInput

provider: aws
interval: 2m
aws:
  batchChangeSize: 100
  secretProvided: true
  credentials:
    secretName: aws-route53-secret
  zonesCacheDuration: 1h
  region: eu-central-1

extraArgs:
  txt-owner-id: prod-eu-ingress

# sets the lookup domain for external-dns
domainFilters: ["prod.eu-central-1.aws.ml.hana.ondemand.com"]
```

And finally, the `.tmpl` has the form

```gotmpl
provider: {{ .cloudName }}
interval: 2m
{{- if eq  .cloudName "aws" -}}
aws:
  batchChangeSize: 100
  secretProvided: true
  credentials:
    secretName: aws-route53-secret
  zonesCacheDuration: 1h
  region: {{ .regionName }}
{{-end }}
extraArgs:
  txt-owner-id: {{ .clusterName }}-ingress

# sets the lookup domain for external-dns
domainFilters:
- {{ .clusterDomain }}
```

#### Results

After the file-generation CLI runs, the following file structure will exists

```file
+-- services
|   +-- external-dns
|   |   +-- values
|   |   |   +-- cluster-values
|   |   |   |   +-- .tmpl
|   |   |   |   +-- aws.eu-central-1.prod-eu.yaml
|   |   |   |   +-- aws.eu-west-1.gitops-pr1.yaml
|   |   |   |   +-- gcp.us-central1.integration.yaml
...
+-- values-cluster
|   +-- aws.eu-central-1.prod-eu.yaml
|   +-- aws.eu-west-1.gitops-pr1.yaml
|   +-- gcp.us-central1.integration.yaml
```

and the newly generated files contain:

`aws.eu-central-1.prod1.yaml`:

```yaml
# Code generated by CLI 'coco generate ...' (version: v99.99.99); DO NOT EDIT.

MyFavorite: Value # HumanInput
provider: aws
interval: 2m
aws:
  batchChangeSize: 100
  secretProvided: true
  credentials:
    secretName: aws-route53-secret
  zonesCacheDuration: 1h
  region: eu-central-1

extraArgs:
  txt-owner-id: prod-eu-ingress

# sets the lookup domain for external-dns
domainFilters: ["prod.eu-central-1.aws.ml.hana.ondemand.com"]
```

`aws.eu-west-1.gitops-pr1.yaml`:

```yaml
# Code generated by CLI 'coco generate ...' (version: v99.99.99); DO NOT EDIT.

provider: aws
interval: 2m
aws:
  batchChangeSize: 100
  secretProvided: true
  credentials:
    secretName: aws-route53-secret
  zonesCacheDuration: 1h
  region: eu-west-1
extraArgs:
  txt-owner-id: gitops-pr1-ingress

# sets the lookup domain for external-dns
domainFilters:
  - gitops-pr1.eu-west-1.mlf-aws-dev.com
```

`gcp.us-central1.integration.yaml`:

```yaml
# Code generated by CLI 'coco generate ...' (version: v99.99.99); DO NOT EDIT.

provider: gcp
interval: 2m
extraArgs:
  txt-owner-id: integration-ingress

# sets the lookup domain for external-dns
domainFilters:
  - integration.us-central1.mlf-gcp-dev.com
```

### Example (kustomize overlay folder)

#### Setup

This example deals with environment-specific overlay folders for rendering a
kustomize application. The relevant inputs for file-generation CLI are in the
following files

```file
+-- services
|   +-- argo
|   |   +-- overlays
|   |   |   +-- .tmpl
|   |   |   |   +-- argo-cm.yaml
|   |   |   |   +-- ingress.yaml
|   |   |   |   +-- kustomization.yaml
|   |   |   |   +-- secret-oidc-client-id.yaml
|   |   |   |   +-- vars-cm.yaml
...
+-- values-cluster
|   +-- aws.eu-central-1.prod-eu.yaml
|   +-- gcp.us-central1.integration.yaml
|   +-- aws.eu-west-1.gitops-pr1.yaml
```

After file-generation, this gives the following folders

```file
+-- services
|   +-- argo
|   |   +-- overlays
|   |   |   +-- .tmpl
                ...
|   |   |   +-- aws.eu-central-1.prod-eu
|   |   |   |   +-- argo-cm.yaml
|   |   |   |   +-- ingress.yaml
|   |   |   |   +-- kustomization.yaml
|   |   |   |   +-- secret-oidc-client-id.yaml
|   |   |   |   +-- vars-cm.yaml
|   |   |   +-- gcp.us-central1.integration/
                ...
|   |   |   +-- aws.eu-west-1.gitops-pr1/
                ...
...
+-- values-cluster
|   +-- aws.eu-central-1.prod-eu.yaml
|   +-- gcp.us-central1.integration.yaml
|   +-- aws.eu-west-1.gitops-pr1.yaml
```

where we droped the remaining files for brevity.
